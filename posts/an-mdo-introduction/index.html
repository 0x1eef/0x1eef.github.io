<!DOCTYPE html>
<HTML lang="en">
<HEAD>
  <META name="generator" content=
  "HTML Tidy for HTML5 for FreeBSD version 5.8.0">
  <TITLE>@0x1eef's personal website</TITLE>
  <META charset="utf-8">
  <META name="viewport" content=
  "width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <LINK rel="icon" sizes="16x16" href="/images/favicon-16x16.png">
  <LINK rel="icon" sizes="32x32" href="/images/favicon-32x32.png">
  <LINK rel="icon" sizes="48x48" href="/images/favicon-48x48.png">
  <LINK rel="icon" sizes="64x64" href="/images/favicon-64x64.png">
  <LINK rel="icon" sizes="128x128" href="/images/favicon-128x128.png">
  <LINK rel="icon" sizes="256x256" href="/images/favicon-256x256.png">
  <LINK rel="stylesheet" href="/css/main.css">
  <SCRIPT src="/js/prism.js" async></SCRIPT>
  <LINK rel="stylesheet" href="/css/prism/github.css">
  <LINK rel="stylesheet" href="/css/prism/tomorrownight.css">
  <META property="og:type" content="article">
  <META property="og:title" content="An mdo(1) introduction">
  <META property="og:description" content=
  "Documents how to use mdo(1) on FreeBSD">
  <META property="og:url" content=
  "https://0x1eef.github.io/posts/an-mdo-introduction">
  <META property="og:image" content="https://0x1eef.github.io/images/og.png">
  <META property="og:image:type" content="image/png">
  <META property="og:image:width" content="512">
  <META property="og:image:height" content="512">
</HEAD>
<BODY class="hidden">
  <HEADER class="main-header">
    <IMG src="/images/og.png" alt="Leaf Logo" class="nav-logo">
    <NAV>
      <UL>
        <LI>
          <A href="/">HOME</A>
        </LI>
        <LI>
          <A href="/posts">POSTS</A>
        </LI>
      </UL>
    </NAV><BUTTON id="theme-toggle" aria-label="Toggle dark mode"><SPAN class=
    "theme-icon-sun" aria-hidden="true">â˜€</SPAN> <SPAN class="theme-icon-moon"
    aria-hidden="true">ðŸŒ™</SPAN></BUTTON>
  </HEADER>
  <MAIN>
    <DIV>
      <H2>About</H2>
      <P>This post takes a quick look at a recent addition to FreeBSD: <A href=
      "https://man.freebsd.org/cgi/man.cgi?mdo">mdo(1)</A>. The mdo utility
      allows a given user or group member to execute a command as another user.
      In that sense, it is similar to the <A href=
      "https://man.openbsd.org?doas">doas(1)</A> program from OpenBSD. At the
      same time, mdo(1) has noticeable differences when compared with doas.
      Let's take a deeper look.</P>
      <H2>Background</H2>
      <P>Traditionally â€“ UNIX programs that let one user execute a command as
      another user (examples: <A href=
      "https://man.openbsd.org/doas">doas(1)</A>, <A href=
      "https://www.man7.org/linux/man-pages/man8/sudo.8.html">sudo(8)</A>) were
      implemented with a setuid binary that is owned by root.</P>
      <P>When a setuid binary is executed by another user, it initially runs
      with an effective user ID of the user who owns the binary and that user
      will often be root. Once the setuid binary is run with the effective user
      id of 0, programs like doas(1) and sudo(8) will execute a system call to
      drop privileges to the "target" user.</P>
      <P>This changes the real|effective user ID along with the real|effective
      group ID associated with the process. Finally, <CODE>execvpe</CODE>
      (another system call) is executed, and a new process starts with the
      privileges of the "target" user. That's the pattern that tools like
      doas(1) and sudo(8) have always followed.</P>
      <P>But <A href="https://man.freebsd.org/mdo">mdo(1)</A> is different. It
      does not depend on a setuid binary. Instead, it depends on a <A href=
      "https://man.freebsd.org/mac_do">mac policy</A> (implemented as a kernel
      module) that can allow an unprivileged user to transition from one
      (effective|real) user/group ID to another (effective|real) user/group ID
      through the <A href="https://man.freebsd.org/setcred">setcred(2)</A>
      system call.</P>
      <P>This difference sets mdo apart from other tools in the same space,
      where traditionally a setuid binary was used. In that sense, mdo(1) is
      pushing the envelope with a new, innovative approach.</P>
      <H2>Policy</H2>
      <P><STRONG>Context</STRONG></P>
      <P>The <A href="https://man.freebsd.org/cgi/man.cgi?mdo">mdo(1)</A>
      utility depends on the <A href=
      "https://man.freebsd.org/cgi/man.cgi?mac_do">mac_do(4)</A> policy. This
      policy must be loaded into the kernel before mdo(1) can be used from the
      command line. The <A href=
      "https://man.freebsd.org/cgi/man.cgi?mac">mac(4)</A> man page provides
      more information about FreeBSD's Mandatory Access Control (MAC)
      framework.</P>
      <H3>Temporary</H3>
      <P>We can quickly try mdo without rebooting the system by loading the
      policy temporarily but the recommended approach is to load the policy
      earlier in the boot process:</P>
      <PRE><CODE class="language-sh">root@freebsd# kldload mac_do
</CODE></PRE>
      <H3>Persistent</H3>
      <P>We can choose to have the mdo policy persist across system reboots and
      loaded into the kernel early in the boot process by updating
      <CODE>/boot/loader.conf</CODE>. This is the recommended approach:</P>
      <PRE><CODE class="language-sh"># /boot/loader.conf
mac_do_load="YES"
</CODE></PRE>
      <H2>Rules</H2>
      <P><STRONG>Context</STRONG></P>
      <P>A rule defines which user or group members can execute a command as
      another user. These rules are stored as a semicolon-separated list and
      can be managed via <A href="https://man.freebsd.org/sysctl">sysctl(8)</A>
      under the <CODE>security.mac.do.rules</CODE> node.</P>
      <P>Each rule consists of two parts: a left-hand side and a right-hand
      side, separated by the <CODE>&gt;</CODE> character. The left-hand side
      describes the source user ID or group ID that is allowed to run a
      command, and the right-hand side describes the target ID that can be
      inherited by user(s) described in the left-hand side of the rule.</P>
      <P>Although <CODE>security.mac.do.rules</CODE> is <EM>roughly</EM>
      analogous to OpenBSD's <CODE>doas.conf</CODE> file it currently cannot
      express the same rules. For example, the doas.conf file lets you choose
      which program can be executed and with what arguments where as mdo(1)
      rules are focused purely on what id transitions are allowed.</P>
      <P>Let's look at some examples of how to define rules:</P>
      <PRE><CODE class=
      "language-sh">root@freebsd# sysctl security.mac.do.rules="uid=$(id -u alice)&gt;uid=$(id -u bob)"
root@freebsd# gid=$(getent group beatles | awk -F: '{print $3}')
root@freebsd# sysctl security.mac.do.rules="gid=${gid}&gt;uid=$(id -u bob)"
root@freebsd# sysctl security.mac.do.rules="uid=$(id -u alice)&gt;uid=0"
root@freebsd# sysctl security.mac.do.rules=uid="$(id -u alice)&gt;any"
</CODE></PRE><BR>
      <P><STRONG>Explanation</STRONG></P>
      <UL>
        <LI>"uid=$(id -u alice)&gt;uid=$(id -u bob)"<BR>
        Permits user <CODE>alice</CODE> to execute commands as user
        <CODE>bob</CODE>.</LI>
        <LI>"gid=${gid}&gt;uid=$(id -u bob)"<BR>
        Permits any member of the <CODE>beatles</CODE> group to execute
        commands as user <CODE>bob</CODE>. The <CODE>gid</CODE> variable is
        first set by looking up the <CODE>beatles</CODE> group ID.</LI>
        <LI>"uid=$(id -u alice)&gt;uid=0"<BR>
        Permits user <CODE>alice</CODE> to execute commands as the
        <CODE>root</CODE> user (UID 0).</LI>
        <LI>"uid=$(id -u alice)&gt;any"<BR>
        Permits user <CODE>alice</CODE> to execute commands as <EM>any</EM>
        other user on the system.<BR>
        This could be risky.</LI>
      </UL>
      <H2>Conclusion</H2>
      <P><STRONG>Context</STRONG></P>
      <P>With the mac_do policy loaded and the relevant rules in place, alice
      can now use the <A href="https://man.freebsd.org/man.cgi?mdo">mdo(1)</A>
      utility to launch the weechat program as bob:</P>
      <PRE><CODE class=
      "language-sh">alice@freebsd$ mdo -u bob /usr/local/bin/weechat
</CODE></PRE><BR>
      <P><STRONG>Explanation</STRONG></P>
      <UL>
        <LI>mdo -u bob /usr/local/bin/weechat<BR>
        Executes the weechat program as the user "bob".</LI>
      </UL>
    </DIV>
  </MAIN>
  <FOOTER>
    <P>This website was generated by <A href="https://go.dev/" target="_blank"
    rel="noopener noreferrer">Golang</A></P>
  </FOOTER>
  <SCRIPT src="/js/main.js"></SCRIPT>
</BODY>
</HTML>
