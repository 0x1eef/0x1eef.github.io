<!DOCTYPE html>
<HTML lang="en">
<HEAD>
  <META name="generator" content=
  "HTML Tidy for HTML5 for FreeBSD version 5.8.0">
  <TITLE>@0x1eef's personal website</TITLE>
  <META charset="utf-8">
  <META name="viewport" content=
  "width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <LINK rel="icon" sizes="16x16" href="/images/favicon-16x16.png">
  <LINK rel="icon" sizes="32x32" href="/images/favicon-32x32.png">
  <LINK rel="icon" sizes="48x48" href="/images/favicon-48x48.png">
  <LINK rel="icon" sizes="64x64" href="/images/favicon-64x64.png">
  <LINK rel="icon" sizes="128x128" href="/images/favicon-128x128.png">
  <LINK rel="icon" sizes="256x256" href="/images/favicon-256x256.png">
  <LINK rel="stylesheet" href="/css/main.css">
  <SCRIPT src="/js/prism.js" async></SCRIPT>
  <LINK rel="stylesheet" href="/css/prism/github.css">
  <LINK rel="stylesheet" href="/css/prism/tomorrownight.css">
  <META property="og:type" content="article">
  <META property="og:title" content=
  "Performance gains with persistent connections">
  <META property="og:description" content=
  "Documents performance gains with persistent connections and llm.rb">
  <META property="og:url" content=
  "https://0x1eef.github.io/posts/persistent-connections-with-llm.rb/">
  <META property="og:image" content="https://0x1eef.github.io/images/og.png">
  <META property="og:image:type" content="image/png">
  <META property="og:image:width" content="512">
  <META property="og:image:height" content="512">
</HEAD>
<BODY class="hidden">
  <HEADER class="main-header">
    <IMG src="/images/og.png" alt="Leaf Logo" class="nav-logo">
    <NAV>
      <UL>
        <LI>
          <A href="/">HOME</A>
        </LI>
        <LI>
          <A href="/posts">POSTS</A>
        </LI>
      </UL>
    </NAV><BUTTON id="theme-toggle" aria-label="Toggle dark mode"><SPAN class=
    "theme-icon-sun" aria-hidden="true">â˜€</SPAN> <SPAN class="theme-icon-moon"
    aria-hidden="true">ðŸŒ™</SPAN></BUTTON>
  </HEADER>
  <MAIN>
    <DIV>
      <H2>About</H2>
      <P><A href="https://github.com/llmrb/llm">llm.rb</A> is a zero-dependency
      Ruby toolkit for interacting with Large Language Models that tries to be
      as robust and useful as libraries with feature-rich dependencies.
      Sometimes that can be challenging, and sometimes it can require
      compromise.</P>
      <P>This post looks at one of those scenarios where we provide a powerful
      performance optimization as an opt-in feature that requires the user to
      install the <A href=
      "https://github.com/drbrain/net-http-persistent">net-http-persistent</A>
      gem separately.</P>
      <H2>Background</H2>
      <H4>Context</H4>
      <P>By default, every request that is made by <A href=
      "https://github.com/llmrb/llm#readme">llm.rb</A> sets up and tears down a
      socket. No attempt is made to reuse the socket, or keep the socket alive.
      This is not always a huge deal but in case it becomes a bottleneck
      <A href="https://github.com/llmrb/llm#readme">llm.rb</A> provides a
      persistent connection pool via <A href=
      "https://github.com/drbrain/net-http-persistent">net-http-persistent</A>.</P>
      <P>The <A href=
      "https://github.com/drbrain/net-http-persistent">net-http-persistent</A>
      gem implements a connection pool where the gem maintains active
      connections that can be reused multiple times across multiple requests,
      and across multiple threads â€“ and good news, it is fully thread-safe.</P>
      <P>The gem should be installed manually:</P>
      <PRE><CODE class="language-sh">gem install net-http-persistent
</CODE></PRE>
      <H4>Pool</H4>
      <P>The next step configures an instance of <A href=
      "https://0x1eef.github.io/x/llm.rb/LLM/OpenAI.html"><CODE>LLM::OpenAI</CODE></A>
      to use a connection pool where each request in the example reuses the
      same socket that was initially created for the first request. This
      approach can significantly improve performance since the cost (DNS
      lookup, TCP / SSL handshakes) of tearing down and setting up a connection
      is limited to a single socket.</P>
      <P>The optimization applies to <STRONG>all</STRONG> requests for a
      <STRONG>single provider</STRONG> - that means a socket can be reused
      across API endpoints, and even across multiple instances of <A href=
      "https://0x1eef.github.io/x/llm.rb/LLM/OpenAI.html"><CODE>LLM::OpenAI</CODE></A>
      that exist in different threads (eg a Sidekiq environment). The
      optimization is applied automatically as long as an object opts in via
      the <CODE>persistent</CODE> option:</P>
      <PRE><CODE class="language-ruby">#!/usr/bin/env ruby
require "llm"
llm = LLM.openai(key: ENV["OPENAI_SECRET"], persistent: true)
res1 = llm.responses.create "message 1"
res2 = llm.responses.create "message 2", previous_response_id: res1.response_id
res3 = llm.responses.create "message 3", previous_response_id: res2.response_id
</CODE></PRE>
      <H2>Conclusion</H2>
      <P>Utilizing persistent HTTP connections in <A href=
      "https://github.com/llmrb/llm#readme">llm.rb</A> is a simple way to boost
      performance for applications that make repeated requests. By opting into
      this feature we can reduce connection overhead and improve throughput â€“
      especially in threaded or high-volume environments.</P>
    </DIV>
  </MAIN>
  <FOOTER>
    <P>This website was generated by <A href="https://go.dev/" target="_blank"
    rel="noopener noreferrer">Golang</A></P>
  </FOOTER>
  <SCRIPT src="/js/main.js"></SCRIPT>
</BODY>
</HTML>
